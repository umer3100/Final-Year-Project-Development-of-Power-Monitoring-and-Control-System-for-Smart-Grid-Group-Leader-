#include <WiFi.h>
#include "ThingSpeak.h"
#include <LiquidCrystal_I2C.h>
#include <math.h>


int wait30 = 30000;  // time to reconnect when connection is lost.

//############################# WIFI CREDENTIALS ###################################

const char* password = "ProjectIoT";
const char* ssid = "IoT_Project";

WiFiClient client;

// ############################# Cloud CREDENTIALS ###################################

unsigned long myChannelNumber = 2519566;
const char* myWriteAPIKey = "B8J74N7J3EO9Z7CX";


// Timer variables
unsigned long lastTime = 0;
WiFiServer server(80);

char host[] = "api.thingspeak.com";      // ThingSpeak address
String APIkey = "2519566";               // Thingspeak Read Key, works only if a PUBLIC viewable channel
String APIreadkey = "JQNWS8M7HRKL5G1G";  // Thingspeak Read Key, works only if a PUBLIC viewable channel
const int httpPort = 80;
const unsigned long HTTP_TIMEOUT = 10000;  // max respone time from server
int a, b, c, d, h = 0;
char f;
String dataIn;

String Voltage1 = "";
String Voltage2 = "";
String Current = "";
String PowerFactor = "";


int intVoltage1 = 0;
int intVoltage2 = 0;
float intCurrent = 0.0;
int intPowerFactor = 0;

float PF = 0.99;

int Power = 0;

int lcdColumns = 16;
int lcdRows = 2;

LiquidCrystal_I2C lcd(0x27, lcdColumns, lcdRows);


void setup()

{
  Serial.begin(115200);
  //  Serial.begin(19200);
  Serial2.begin(9600);

  lcd.init();
  lcd.backlight();


  delay(100);
  Serial.println("Done!");


  WiFi.mode(WIFI_STA);
  ThingSpeak.begin(client);  // Initialize ThingSpeak
  // Start Web Server.
  server.begin();
  Serial.println("Web Server started.");
  Serial.println("Done!");

  lcd.setCursor(0, 0);
  lcd.print("   Smart Grid");
  lcd.setCursor(0, 1);
  lcd.print("     Project ");
  delay(5000);
  lcd.clear();
}

void loop() {
  lcd.clear();
  Serial.println("Printing Data on LCD");
  lcd.setCursor(0, 0);
  lcd.print("Vi=");
  lcd.print(intVoltage1);
  lcd.print("; VL=");
  lcd.print(intVoltage2);
  lcd.setCursor(0, 1);
  lcd.print("P=");
  lcd.print(Power);
  lcd.print("; PF=");
  lcd.print(PF);
  delay(1000);

  Serial.println("Connected and in void loop");
  while (Serial2.available()) {
    f = Serial2.read();
    if (f != '\n') {
      dataIn += f;
    } else {
      break;
    }
  }
  if (f == '\n') {
    Serial.println(dataIn);
    if (dataIn.indexOf("Data") != -1) {
      Voltage1 = dataIn.substring(dataIn.indexOf(":") + 1, dataIn.indexOf(","));
      Serial.print("Voltage1 is: ");
      Serial.print(Voltage1);
      Voltage2 = dataIn.substring(dataIn.indexOf(",") + 1, dataIn.indexOf(";"));
      Serial.print("Voltage2 is: ");
      Serial.print(Voltage2);
      Current = dataIn.substring(dataIn.indexOf(";") + 1, dataIn.indexOf("?"));
      Serial.print("Current is: ");
      Serial.print(Current);
      PowerFactor = dataIn.substring(dataIn.indexOf("?") + 1, dataIn.lastIndexOf("@"));
      Serial.print("Power Factor is: ");
      Serial.println(PowerFactor);
      intVoltage1 = Voltage1.toInt();
      intVoltage2 = Voltage2.toInt();
      intCurrent = Current.toFloat();
      PF = PowerFactor.toFloat();
    }
//      h = dataIn.toInt();
      f = 0;
      dataIn = "";
    }
    PF = PF/100.0;
    Serial.print("PowerFactor= ");
    Serial.println(PF);
    Power = intVoltage2*intCurrent;

    if ((WiFi.status() != WL_CONNECTED) && (millis() > wait30)) {
      Serial.println("Trying to reconnect WiFi...");
      WiFi.disconnect();
      WiFi.begin(ssid, password);
      wait30 = millis() + 30000;
    }
    Serial.println("Connected with WiFi.");
    Serial.print("This is IP to connect to the WebServer: ");
    Serial.print("http://");
    Serial.println(WiFi.localIP());


    ThingSpeak.setField(1, intVoltage1);
    ThingSpeak.setField(2, intVoltage2);
    ThingSpeak.setField(3, intCurrent);
    ThingSpeak.setField(4, Power);
    ThingSpeak.setField(5, PF);
    //  ThingSpeak.setField(6, status);

    int x = ThingSpeak.writeFields(myChannelNumber, myWriteAPIKey);

    if (x == 200) {
      Serial.println("Channel updated successful.");
    } else {
      Serial.println("Problem updating channel. HTTP error code " + String(x));
    }

    // Check if a client has connected..
    WiFiClient client = server.available();
    if (!client) {
      return;
    }
    Serial.print("New client: ");
    Serial.println(client.remoteIP());
  }
